{% extends "base.html" %}

{% block title %}Innstillinger - Et blikk for eleven{% endblock %}

{% block content %}
<h1 class="mb-4"><i class="fas fa-cog me-2"></i>Innstillinger</h1>

<!-- Kategorivalg -->
<div class="card mb-4">
  <div class="card-header"><strong>Kategorivalg</strong></div>
  <div class="card-body">
    <p>Skru av/på hvilke hoved- og underkategorier som skal vises i observasjonsbildet.</p>
    <div id="category-settings"></div>
    <button class="btn btn-primary mt-3" onclick="saveCategorySettings()"><i class="fas fa-save me-1"></i>Lagre valg</button>
    <span id="cat-save-status" class="ms-3 text-success" style="display:none;">Lagret!</span>
  </div>
</div>

<!-- Endre PIN -->
<div class="card mb-4">
  <div class="card-header"><strong>Endre PIN</strong></div>
  <div class="card-body">
    <form id="pinForm" method="POST" action="/change_pin">
      <div class="mb-2">
        <label for="old_pin" class="form-label">Nåværende PIN</label>
        <input type="password" class="form-control" id="old_pin" name="old_pin" required minlength="4">
      </div>
      <div class="mb-2">
        <label for="new_pin" class="form-label">Ny PIN</label>
        <input type="password" class="form-control" id="new_pin" name="new_pin" required minlength="4">
      </div>
      <div class="mb-2">
        <label for="confirm_pin" class="form-label">Gjenta ny PIN</label>
        <input type="password" class="form-control" id="confirm_pin" name="confirm_pin" required minlength="4">
      </div>
      <button type="submit" class="btn btn-secondary mt-2"><i class="fas fa-key me-1"></i>Bytt PIN</button>
      {% if error %}<div class="text-danger mt-2">{{ error }}</div>{% endif %}
      {% if success %}<div class="text-success mt-2">{{ success }}</div>{% endif %}
    </form>
  </div>
</div>

<!-- Eksport -->
<div class="card mb-4">
  <div class="card-header"><strong>Eksport</strong></div>
  <div class="card-body">
    <form id="exportForm" method="POST" action="/export_data">
      <div class="mb-3">
        <label for="class_id_export" class="form-label">Velg klasse</label>
        <select class="form-select" name="class_id" id="class_id_export" required>
          <!-- Klassenavnene fylles inn her -->
        </select>
      </div>
      <div class="mb-3">
        <label for="exportType" class="form-label">Velg eksporttype</label>
        <select class="form-select" id="exportType" name="exportType" required>
          <option value="class">Hele klassen</option>
          <option value="student">Enkeltelev</option>
        </select>
      </div>
      <div class="mb-3" id="studentSelectExport" style="display:none;">
        <label for="student_id_export" class="form-label">Velg elev</label>
        <select class="form-select" name="student_id" id="student_id_export"></select>
      </div>
      <button type="button" class="btn btn-outline-info me-2" id="showGraphBtn"><i class="fas fa-chart-bar me-1"></i>Vis utvikling</button>
      <!-- Modal for graf -->
      <div id="exportGraphModal" class="modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Visuell graf</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Lukk"></button>
            </div>
            <div class="modal-body">
              <canvas id="exportGraphCanvas" style="width:100%;max-width:700px;"></canvas>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Tilbakestill app -->
<div class="card mb-4">
  <div class="card-header"><strong>Tilbakestill app</strong></div>
  <div class="card-body">
    <button class="btn btn-outline-danger" onclick="confirmReset()"><i class="fas fa-trash me-1"></i>Slett alle data og tilbakestill</button>
    <span id="reset-status" class="ms-3 text-success" style="display:none;">Appen er tilbakestilt!</span>
  </div>
</div>

<!-- Tema -->
<div class="card mb-4">
  <div class="card-header"><strong>Tema</strong></div>
  <div class="card-body">
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="themeSwitch">
      <label class="form-check-label" for="themeSwitch">Mørkt tema</label>
    </div>
  </div>
</div>

<!-- Om appen -->
<div class="card mb-4">
  <div class="card-header"><strong>Om appen</strong></div>
  <div class="card-body">
    <p>Et blikk for eleven<br>Versjon 1.0<br>Lærerliv 2025</p>
    <a href="/privacy_info" class="btn btn-link">Personvern</a>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// --- Kategorivalg (lagres i localStorage) ---
// Fix for Jinja2 variables in JavaScript
const OBS_CATEGORIES = JSON.parse('{{ observation_categories|tojson|safe }}');
const OBS_DISPLAY = JSON.parse('{{ observation_display|tojson|safe }}');
const classList = JSON.parse('{{ classes|tojson|safe }}');
const studentList = JSON.parse('{{ students|tojson|safe }}');

function renderCategorySettings() {
  const root = document.getElementById('category-settings');
  root.innerHTML = '';
  const saved = JSON.parse(localStorage.getItem('category_settings') || '{}');
  Object.entries(OBS_CATEGORIES).forEach(([hoved, under], i) => {
    const mainId = 'maincat_' + hoved;
    const mainChecked = saved[hoved] !== false;
    const mainDiv = document.createElement('div');
    mainDiv.className = 'form-check form-switch mb-2';
    mainDiv.innerHTML = `<input class="form-check-input" type="checkbox" id="${mainId}" ${mainChecked ? 'checked' : ''}>
      <label class="form-check-label fw-bold" for="${mainId}">${hoved.replace('_',' ').charAt(0).toUpperCase() + hoved.replace('_',' ').slice(1)}</label>`;
    root.appendChild(mainDiv);
    // Underkategorier
    under.forEach(underkat => {
      const subId = 'subcat_' + underkat;
      const subChecked = !saved[underkat] === false;
      const subDiv = document.createElement('div');
      subDiv.className = 'form-check ms-4';
      subDiv.innerHTML = `<input class="form-check-input" type="checkbox" id="${subId}" ${subChecked ? 'checked' : ''}>
        <label class="form-check-label" for="${subId}">${OBS_DISPLAY[underkat]}</label>`;
      root.appendChild(subDiv);
    });
  });
}
function saveCategorySettings() {
  const saved = {};
  Object.entries(OBS_CATEGORIES).forEach(([hoved, under]) => {
    saved[hoved] = document.getElementById('maincat_' + hoved).checked;
    under.forEach(underkat => {
      saved[underkat] = document.getElementById('subcat_' + underkat).checked;
    });
  });
  localStorage.setItem('category_settings', JSON.stringify(saved));
  document.getElementById('cat-save-status').style.display = '';
  setTimeout(() => document.getElementById('cat-save-status').style.display = 'none', 1500);
}
document.addEventListener('DOMContentLoaded', renderCategorySettings);

// --- Tema ---
const themeSwitch = document.getElementById('themeSwitch');
if (themeSwitch) {
  themeSwitch.checked = document.documentElement.getAttribute('data-bs-theme') === 'dark';
  themeSwitch.addEventListener('change', function() {
    document.documentElement.setAttribute('data-bs-theme', this.checked ? 'dark' : 'light');
    localStorage.setItem('theme', this.checked ? 'dark' : 'light');
  });
}
// Last valgt tema ved oppstart
if (localStorage.getItem('theme')) {
  document.documentElement.setAttribute('data-bs-theme', localStorage.getItem('theme'));
}

// --- Tilbakestill app ---
function confirmReset() {
  if (confirm('Er du sikker på at du vil slette alle data? Dette kan ikke angres.')) {
    fetch('/reset_app', {method:'POST'}).then(() => {
      localStorage.clear();
      document.getElementById('reset-status').style.display = '';
      setTimeout(() => location.reload(), 1200);
    });
  }
}

// Dynamisk visning av elev/klassevalg basert på eksport/statistikk-type
function updateExportForm(type, prefix) {
  document.getElementById('studentSelect' + prefix).style.display = type === 'student' ? '' : 'none';
  document.getElementById('classSelect' + prefix).style.display = type === 'class' ? '' : 'none';
}

// Fyll klasser og elever dynamisk (for demo, bruk server-side rendering i prod)
function populateSelect(selectId, items, valueKey, labelKey) {
  const select = document.getElementById(selectId);
  select.innerHTML = '';
  items.forEach(item => {
    const opt = document.createElement('option');
    opt.value = item[valueKey];
    opt.textContent = item[labelKey];
    select.appendChild(opt);
  });
}

function filterStudentsByClass(classId) {
  const filtered = studentList.filter(s => s.class_id == classId);
  populateSelect('student_id_export', filtered, 'id', 'name');
}

document.addEventListener('DOMContentLoaded', function() {
  // Statistikk
  var statsType = document.getElementById('statisticsType');
  if (statsType) {
    statsType.addEventListener('change', function() {
      updateExportForm(this.value, 'Stats');
    });
  }
  // Fyll klasse-select for eksport
  var classSelectExport = document.getElementById('class_id_export');
  var exportType = document.getElementById('exportType');
  var studentSelectExport = document.getElementById('studentSelectExport');
  var showGraphBtn = document.getElementById('showGraphBtn');
  if (classSelectExport && exportType && studentSelectExport && showGraphBtn) {
    classSelectExport.innerHTML = '<option value="" disabled selected>Velg klasse</option>';
    if (Array.isArray(classList) && classList.length > 0) {
      classList.forEach(cls => {
        var opt = document.createElement('option');
        opt.value = cls.id;
        opt.textContent = cls.name;
        classSelectExport.appendChild(opt);
      });
    } else {
      var opt = document.createElement('option');
      opt.value = "";
      opt.textContent = "Ingen klasser funnet";
      classSelectExport.appendChild(opt);
    }
    exportType.addEventListener('change', function() {
      if(this.value === 'student') {
        studentSelectExport.style.display = '';
        filterStudentsByClass(classSelectExport.value);
      } else {
        studentSelectExport.style.display = 'none';
      }
    });
    classSelectExport.addEventListener('change', function() {
      if(exportType.value === 'student') {
        filterStudentsByClass(this.value);
      }
    });
    showGraphBtn.addEventListener('click', function(e) {
      e.preventDefault();
      const classId = classSelectExport.value;
      const type = exportType.value;
      const studentId = document.getElementById('student_id_export').value;
      fetchObservationData(classId, studentId, type, function(data) {
        showExportGraph(data, type);
      });
      // Vis modal (Bootstrap 5)
      const modal = new bootstrap.Modal(document.getElementById('exportGraphModal'));
      modal.show();
    });
  }
  // Fyll select-bokser for statistikk
  if (document.getElementById('student_id_stats')) {
    populateSelect('student_id_stats', studentList, 'id', 'name');
  }
  // Initielt skjul for statistikk (kun hvis elementene finnes)
  if (document.getElementById('studentSelectStats') && document.getElementById('classSelectStats')) {
    updateExportForm('class', 'Stats');
  }
  if (studentSelectExport) studentSelectExport.style.display = 'none';
});
</script>
{% endblock %}
